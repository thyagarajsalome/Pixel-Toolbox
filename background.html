<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Background Remover - Multiple Images</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        text-align: center;
        margin: 0;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      #canvas {
        border: 1px solid #ccc;
        max-width: 100%;
        margin-top: 20px;
        cursor: crosshair;
      }
      .controls {
        margin-top: 20px;
      }
      .control-group {
        margin-bottom: 10px;
      }
      label {
        margin-right: 10px;
      }
      input[type="range"] {
        vertical-align: middle;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        background: #007bff;
        color: #fff;
        cursor: pointer;
        border-radius: 4px;
      }
      button:disabled {
        background: #aaa;
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        background: #0056b3;
      }
      #colorDisplay {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 1px solid #ccc;
        vertical-align: middle;
        margin-left: 10px;
      }
      /* Gallery styles */
      .gallery {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }
      .thumbnail {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border: 2px solid transparent;
        cursor: pointer;
      }
      .thumbnail.active {
        border: 2px solid #007bff;
      }
    </style>
  </head>
  <body>
    <h1>Background Remover - Multiple Images</h1>
    <div class="controls">
      <div class="control-group">
        <!-- Allow multiple file selection -->
        <input type="file" id="upload" accept="image/jpeg" multiple />
      </div>
      <!-- Gallery to display uploaded image thumbnails -->
      <div class="gallery" id="gallery"></div>
      <div class="control-group">
        <button id="removeButton" disabled>Remove Background</button>
        <button id="resetButton" disabled>Reset</button>
        <button id="downloadButton" disabled>Download PNG</button>
      </div>
      <div class="control-group">
        <label for="tolerance">
          Tolerance: <span id="toleranceValue">50</span>
        </label>
        <input type="range" id="tolerance" min="0" max="100" value="50" />
      </div>
      <div class="control-group">
        <p>Click on the image (in the canvas) to select the background color</p>
        <span>Selected Color:</span>
        <div id="colorDisplay"></div>
      </div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
      // Global variables to store the images and current state
      let images = []; // Array to store uploaded images info
      let currentIndex = -1; // Index of the currently selected image
      let currentOriginalImage = null; // Original image data of the selected image
      let currentBgColor = null; // Selected background color

      // DOM elements
      const upload = document.getElementById("upload");
      const gallery = document.getElementById("gallery");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const removeButton = document.getElementById("removeButton");
      const resetButton = document.getElementById("resetButton");
      const downloadButton = document.getElementById("downloadButton");
      const toleranceSlider = document.getElementById("tolerance");
      const toleranceValue = document.getElementById("toleranceValue");
      const colorDisplay = document.getElementById("colorDisplay");

      // Update tolerance display when slider changes
      toleranceSlider.addEventListener("input", () => {
        toleranceValue.textContent = toleranceSlider.value;
      });

      // Handle multiple file uploads and create thumbnails in the gallery
      upload.addEventListener("change", (e) => {
        const files = e.target.files;
        if (!files.length) return;
        images = []; // Reset images array
        gallery.innerHTML = ""; // Clear previous thumbnails
        currentIndex = -1;

        Array.from(files).forEach((file, index) => {
          // Only process JPG images
          if (!file.type.match("image/jpeg")) {
            return;
          }
          const reader = new FileReader();
          reader.onload = function (event) {
            const imgSrc = event.target.result;
            // Create a thumbnail for the gallery
            const thumb = document.createElement("img");
            thumb.src = imgSrc;
            thumb.classList.add("thumbnail");
            thumb.title = file.name;
            thumb.addEventListener("click", () => {
              selectImage(index);
            });
            gallery.appendChild(thumb);
            // Store the image info
            images.push({
              file: file,
              src: imgSrc,
              thumbnailElement: thumb,
            });
            // Auto-select the first image uploaded
            if (currentIndex === -1) {
              selectImage(0);
            }
          };
          reader.readAsDataURL(file);
        });
      });

      // Function to load a selected image into the canvas
      function selectImage(index) {
        currentIndex = index;
        currentBgColor = null;
        colorDisplay.style.backgroundColor = "transparent";
        // Remove active styling from all thumbnails and highlight the selected one
        images.forEach((imgObj) => {
          imgObj.thumbnailElement.classList.remove("active");
        });
        images[index].thumbnailElement.classList.add("active");

        const img = new Image();
        img.onload = function () {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
          // Save the original image data for later reset
          currentOriginalImage = ctx.getImageData(
            0,
            0,
            canvas.width,
            canvas.height
          );
          removeButton.disabled = false;
          resetButton.disabled = false;
          downloadButton.disabled = false;
        };
        img.src = images[index].src;
      }

      // Allow user to click the canvas to select the background color
      canvas.addEventListener("click", (e) => {
        if (!currentOriginalImage) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const pixel = ctx.getImageData(x, y, 1, 1).data;
        currentBgColor = { r: pixel[0], g: pixel[1], b: pixel[2] };
        colorDisplay.style.backgroundColor = `rgb(${currentBgColor.r}, ${currentBgColor.g}, ${currentBgColor.b})`;
      });

      // Process the currently selected image to remove its background
      removeButton.addEventListener("click", () => {
        if (!currentOriginalImage || !currentBgColor) {
          alert(
            "Please select an image and choose a background color by clicking on the canvas."
          );
          return;
        }
        const tolerance = parseInt(toleranceSlider.value, 10);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i],
            g = data[i + 1],
            b = data[i + 2];
          // Compute the Euclidean distance between the pixel and the chosen background color
          const diff = Math.sqrt(
            Math.pow(r - currentBgColor.r, 2) +
              Math.pow(g - currentBgColor.g, 2) +
              Math.pow(b - currentBgColor.b, 2)
          );
          if (diff < tolerance) {
            data[i + 3] = 0; // Make the pixel transparent
          }
        }
        ctx.putImageData(imageData, 0, 0);
      });

      // Reset the canvas to the original image
      resetButton.addEventListener("click", () => {
        if (currentOriginalImage) {
          ctx.putImageData(currentOriginalImage, 0, 0);
          currentBgColor = null;
          colorDisplay.style.backgroundColor = "transparent";
        }
      });

      // Download the processed image as a PNG
      downloadButton.addEventListener("click", () => {
        const link = document.createElement("a");
        const fileNameWithoutExt = images[currentIndex].file.name.split(".")[0];
        link.download = `background_removed_${fileNameWithoutExt}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    </script>
  </body>
</html>
